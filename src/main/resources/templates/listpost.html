<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Post</title>
	<link rel="stylesheet" href="/css/PostStyle.css">
	<style>
		.comment-section {
			position: relative;
		}

		.comment-list li {
			margin-bottom: 10px;
			position: relative;
		}

		.comment-content {
			display: block;
			font-size: 14px;
			display: inline-block;
		}

		.comment-date {
			font-size: 12px;
			color: gray;
			display: block;
			margin-top: 5px;
		}

		.time-diff {
			font-size: 12px;
			color: gray;
			display: block;
			margin-top: 5px;
		}

		.create-comment {
			margin-top: 10px;
		}

		.comment-options {
			float: right;
			position: relative;
		}

		.comment-options {
			display: flex;
			align-items: center;
			/* Giữa theo chiều dọc */
			position: relative;
		}

		.comment-options button {
			display: inline-block;
			padding: 20px;
			/* Điều chỉnh giá trị padding để giảm khoảng cách */
			font-size: 12px;
			margin-right: 5px;
			/* Điều chỉnh giá trị margin để giảm khoảng cách với nội dung */
			color: rgb(255, 128, 192);
		}

		.comment-options:hover .comment-options-menu {
			display: block;
		}

		.update-comment,
		.delete-comment {
			display: inline-block;
			cursor: pointer;
			margin-right: 5px;
			color: rgb(255, 128, 192);
		}

		.update-comment:hover,
		.delete-comment:hover {
			background-color: rgb(0, 255, 255);
			color: rgb(0, 255, 64);
		}

		.comment-options-menu {
			display: none;
			position: absolute;
			right: 0;
			background-color: rgb(255, 0, 128);
			min-width: 160px;
			box-shadow: 0 8px 16px rgb(255, 255, 0);
			z-index: 1;
			text-align: right;
		}

		.comment-options-button:hover+.comment-options-menu,
		.comment-options-menu:hover {
			display: block;
		}

		.comment-options-menu:not(.active) {
			display: none;
		}

		.comment-options-menu.active {
			display: block;
		}

		.comment-options-menu button {
			cursor: pointer;
			padding: 5px;
			/* Điều chỉnh kích thước padding */
			font-size: 10px;
			/* Điều chỉnh kích thước font */
			color: rgb(255, 128, 192);
		}

		.comment-options-menu button:hover {
			background-color: rgb(0, 255, 255);
			color: rgb(0, 255, 64);
		}

		.comment-options-menu {
			display: none;
			position: absolute;
			right: 0;
			background-color: rgb(255, 0, 128);
			box-shadow: 0 8px 16px rgb(255, 255, 0);
			z-index: 1;
			text-align: right;
			border-radius: 5px;
		}
	</style>
</head>

<body>
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
	<div class="container bootstrap snippets bootdey" id="Post-Container">
		<div class="row">
			<!-- Bắt đầu vòng lặp qua tất cả bài viết -->
			<div th:each="post : ${list}" class="col-md-6">
				<section class="widget">
					<div class="widget-controls">
						<a href="#"><i class="fa fa-refresh"></i></a>
						<a href="#" data-widgster="close"><i class="glyphicon glyphicon-remove"></i></a>
					</div>
					<div class="widget-body">
						<div class="widget-top-overflow text-white">
							<img th:src="${post.imageURL}" alt="Post Image">
							<ul class="tags text-white pull-right">
								<li><a href="#">design</a></li>
								<li><a href="#">white</a></li>
							</ul>
						</div>
						<div class="post-user mt-sm">
							<span class="thumb pull-left mr">
								<img class="img-circle" src="https://bootdey.com/img/Content/user_1.jpg" alt="...">
							</span>
							<h5 class="mb-xs mt-xs" th:text="${post.userFullName}"></h5>
							<p class="fs-mini text-muted"><time>25 mins</time> &nbsp; <i class="fa fa-map-marker"></i>
								&nbsp; near Amsterdam</p>
						</div>
						<p class="text-light fs-mini m" th:text="${post.content}"></p>

						<!-- Comment Section -->
						<div class="comment-section">
							<input type="text" class="comment-input" placeholder="Add a comment..."
								th:id="'commentInput-' + ${post.postID}" />
							<!-- Change this line -->
							<button th:onclick="'loadComments(' + ${post.postID} + ')'" class="comment-button">Load
								Comments</button>


							<!-- Display comments -->
							<!-- Display comments -->
							<ul class="comment-list" th:id="'commentList-' + ${post.postID}">
								<li th:each="comment : ${response}" class="comment-list-item">
									<!-- Hiển thị nội dung bình luận -->
									<span class="comment-content">
										<span th:text="${comment.userName}"></span>:
										<span th:text="${comment.content}"></span>
									</span>

									<!-- Hiển thị ngày bình luận -->
									<span class="comment-date" th:text="${comment.commentDate}"></span>

									<!-- Nút Options và Nút Update/Delete -->
									<div class="comment-options">
										<button class="options-button"
											onclick="toggleCommentOptions(this, '${comment.commentId}')">Options</button>

										<div class="comment-options-menu">
											<span class="update-comment"
												onclick="showEditForm('${comment.commentId}', '${comment.content}')">Update</span>
											<span class="delete-comment"
												onclick="deleteComment('${comment.commentId')">Delete</span>
										</div>
									</div>
								</li>
							</ul>




							<!-- Create Comment Section -->
							<!-- Inside the create-comment div -->
							<div class="create-comment">
								<form id="createCommentForm" th:action="'/create/' + ${post.postID}" method="post">
									<input type="text" class="create-comment-input" placeholder="Your comment..."
										th:id="'createCommentInput' + ${post.postID}" name="content" required />
									<button type="submit" class="create-comment-button">Create Comment</button>
								</form>
							</div>

						</div>
					</div>
					<footer class="bg-body-light">
						<ul class="post-links no-separator">
							<li>
								<a role="button" th:onclick="'likePost(' + ${post.postID} + ')'"
									th:id="'s' + ${post.postID}">
									<i class="fa fa-heart" th:id="'likeButton' + ${post.postID}"></i>
									<span th:id="'likeCount' + ${post.postID}" th:text="${post.likeCount}"></span>
								</a>
							</li>
							<li><a href="#"><i class="glyphicon glyphicon-comment"></i> 98</a></li>
						</ul>
					</footer>
				</section>
			</div>
			<!-- Kết thúc vòng lặp -->
		</div>
	</div>

	<!-- -----------------------------------------------------------script------------------------------------- -->
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<script defer>
		$(document).ready(function () {
			$('form').submit(function (event) {
				event.preventDefault(); // Prevent the default form submission behavior
				var postId = $(this).attr('action').split('/').pop();
				// Get the form data
				var formData = {
					content: $('#createCommentInput' + postId).val() // Assuming you have a createCommentInput element
				};

				// Get the post ID from the form's action attribute

				$.ajax({
					type: 'POST',
					url: '/create/' + postId,
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(formData),
					success: function (response) {
						loadComments(postId);
						$('#createCommentInput' + postId).val('')
					},
					error: function (xhr, status, error) {
						alert('Thanh cong');
						loadComments(postId);
						$('#createCommentInput' + postId).val('')
					}
				});
			});
		});

	</script>
	<script defer>
		function loadComments(postId) {
			const postIdNumeric = parseInt(postId);

			if (!isNaN(postIdNumeric)) {
				$.ajax({
					type: 'GET',
					url: '/comment/' + postIdNumeric,
					success: function (response) {
						const commentList = $('#commentList-' + postId);
						commentList.empty();

						response.forEach(function (comment) {
							var commentElement = $('<li><span class="comment-content"></span><span class="comment-date"></span><span class="time-diff"></span></li>');
							commentElement.find('span.comment-content').text(comment.userName + ': ' + comment.content);
							commentElement.find('span.comment-date').text(comment.commentDate);

							// Calculate and display the time difference
							var timeDiffElement = commentElement.find('span.time-diff');
							var commentDate = new Date(comment.commentDate);
							var now = new Date();

							var timeDiff = now - commentDate;
							var seconds = Math.floor(timeDiff / 1000);
							var minutes = Math.floor(seconds / 60);
							var hours = Math.floor(minutes / 60);
							var days = Math.floor(hours / 24);

							if (days > 0) {
								timeDiffElement.text(days + ' days ago');
							} else if (hours > 0) {
								timeDiffElement.text(hours + ' hours ago');
							} else if (minutes > 0) {
								timeDiffElement.text(minutes + ' minutes ago');
							} else {
								timeDiffElement.text('Just now');
							}
							// Add the three-dot button for comment options
							commentElement.append('<button class="comment-options" onclick="toggleCommentOptions(this)" ' +
								'data-comment-id="' + comment.commentId + '" data-comment-content="' + comment.content + '" id="optionsButton-' + comment.commentId + '">Options</button>');

							commentElement.append('<div class="comment-options-menu" style="display: none;" id="commentOptionsMenu-' + comment.commentId + '">' +
								'<button class="edit-comment-button" onclick="showEditForm(\'' + comment.commentId + '\', \'' + comment.content + '\')">Edit</button>' +
								'<button class="delete-comment-button" onclick="deleteComment(\'' + comment.commentId + '\')">Delete</button>' +
								'</div>');

							// Add a class to uniquely identify the comment options menu
							commentElement.find('.comment-options-menu').addClass('comment-options-menu-' + comment.commentId);

							commentList.append(commentElement);

						});
					},
					error: function (xhr, status, error) {
						console.error("Error loading comments: ", xhr.responseText);
						alert('Error loading comments');
					}
				});
			} else {
				alert('Invalid post ID.');
			}
		}
		function toggleCommentOptions(button) {
			console.log('Toggle Comment Options clicked!');

			// Find the comment-options-menu related to the clicked button
			const commentOptions = $(button).siblings('.comment-options-menu');

			// Hide all comment-options-menus except the one related to the clicked button
			$('.comment-options-menu').not(commentOptions).hide();

			// Toggle the display of the comment-options-menu related to the clicked button
			commentOptions.toggle();
		}
		function deleteComment(commentId) {
			const confirmDelete = confirm('Do you want to delete the comment?');
			if (confirmDelete) {
				// Get the post ID
				const postId = $('.comment-options-menu-' + commentId).closest('.col-md-6').find('.comment-button').attr('onclick').match(/\d+/)[0];

				// Perform the delete action here (using AJAX)
				$.ajax({
					type: 'DELETE',
					url: '/comment/delete/' + postId + '/' + commentId,
					success: function (response) {
						alert('Delete Comment: ID ' + commentId + ' Successful');
						// Reload the comment list after deleting
						loadComments(postId);
					},
					error: function (xhr, status, error) {
						console.error("Error deleting comment: ", xhr.responseText);
						alert('Error deleting comment');
					}
				});
			}
		}




		function showEditForm(commentId, commentContent) {
			// Check if an edit form is already active for this comment
			const existingEditForm = $('.comment-options-menu-' + commentId).find('.edit-comment-input');
			if (existingEditForm.length > 0) {
				// If an edit form is active, return without creating a new one
				return;
			}

			// Display the confirmation window with the input field and Update/Cancel buttons
			const confirmUpdate = confirm('Do you want to update the comment?');
			if (confirmUpdate) {
				const editForm = $('<div><input type="text" class="edit-comment-input" value="' + commentContent + '"/> ' +
					'<button class="update-comment-button" onclick="updateComment(\'' + commentId + '\')">Update</button>' +
					'<button class="cancel-comment-button" onclick="cancelEdit()">Cancel</button></div>');

				// Replace the comment content with the edit form
				const commentOptionsMenu = $('.comment-options-menu-' + commentId);
				const commentContentSpan = commentOptionsMenu.siblings('.comment-content');
				commentContentSpan.html(editForm);
			}
		}



		function updateComment(commentId) {
			// Get the content from the input field
			const updatedContent = $('.edit-comment-input').val();

			// Get the post ID
			const postId = $('.comment-options-menu-' + commentId).closest('.col-md-6').find('.comment-button').attr('onclick').match(/\d+/)[0];

			// Perform the AJAX update action
			$.ajax({
				type: 'PUT',
				url: '/comment/update/' + postId,
				headers: {
					'Accept': 'application/json',
					'Content-Type': 'application/json'
				},
				data: JSON.stringify({content: updatedContent, commentId: commentId}),
				success: function (response) {
					// Reload the comment list after updating
					loadComments(postId);

					// Close the edit form
					cancelEdit();
				},
				error: function (xhr, status, error) {
					alert('Thanh cong');
					loadComments(postId);

				}
			});
		}


		function cancelEdit() {
			// Close the edit form and show the comment content again
			const commentContentSpan = $('.comment-options:visible').siblings('.comment-content');
			const commentContent = commentContentSpan.find('.edit-comment-input').val();
			commentContentSpan.html('' + commentContent);

			// Hide the edit form
			$('.edit-comment-input').remove();
			$('.update-comment-button').remove();
			$('.cancel-comment-button').remove();
		}
	</script>


</body>

</html>
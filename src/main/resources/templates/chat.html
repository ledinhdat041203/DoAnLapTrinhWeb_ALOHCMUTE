<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Messages</title>
	
	<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
	<script type="module">
		import {initializeApp} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
		import {getAnalytics} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-analytics.js";
		import {getDatabase, ref, onChildAdded, off} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js";

		const firebaseConfig = {
			apiKey: "AIzaSyAktz6fBLYH1GcUykJi8JF5WHwI6dNncuY",
			authDomain: "chatrealtime-7e7e8.firebaseapp.com",
			databaseURL: "https://chatrealtime-7e7e8-default-rtdb.firebaseio.com",
			projectId: "chatrealtime-7e7e8",
			storageBucket: "chatrealtime-7e7e8.appspot.com",
			messagingSenderId: "206925157542",
			appId: "1:206925157542:web:7e254501d41af820ed9067",
			measurementId: "G-0PDLXSS9SN"
		};

		const app = initializeApp(firebaseConfig);
		const analytics = getAnalytics(app);
		const conversationId = "[[${conversationId}]]";
		console.log('Conversation ID:', conversationId);

		const userid = document.getElementById('userid');
		const userCurrent = userid.value;

		const database = getDatabase(app);
		const messagesRef = ref(database, 'RealTimeChat/' + conversationId + '/messages');
		off(messagesRef);
		onChildAdded(messagesRef, (snapshot) => {
			const message = snapshot.val();
			const chatDiv = document.getElementById('chat');
			const newMessage = document.createElement('li');

			if (message.sender == userCurrent) {
				newMessage.className = 'me';
			} else {
				newMessage.className = 'you';
			}
			// Ki·ªÉm tra xem tin nh·∫Øn c√≥ ch·ª©a link ·∫£nh hay kh√¥ng
			const hasImage = message.content.includes('++');

			if (hasImage) {
				// N·∫øu c√≥ ·∫£nh, t√°ch n·ªôi dung v√† link ·∫£nh
				const [imageUrl, content] = message.content.split('++');
				newMessage.innerHTML = `
            <div class="text-box"><p>${content}</p>
             <img src="${imageUrl}" alt="Attached Image" style="width: 300px; height: 200px;"></div>
        `;
			} else {
				// N·∫øu kh√¥ng c√≥ ·∫£nh
				newMessage.innerHTML = `
            <div class="text-box"><p>${message.content}</p></div>
        `;
			}
			chatDiv.appendChild(newMessage);
			chatDiv.scrollTop = chatDiv.scrollHeight;
			//newMessage.scrollIntoView({behavior: 'smooth'});
		});

		const uid = localStorage.getItem('recvId');
		const recvName = localStorage.getItem('recvName');
		// Set gi√° tr·ªã recvName v√†o n·ªôi dung c·ªßa th·∫ª p trong Receiver-Name
		document.getElementById('Receiver-Name').innerHTML = `<p><strong>${recvName}</strong></p>`;
		document.getElementById('Receiver-Name-About').innerHTML = `<p><strong>${recvName}</strong></p>`;
		// Set gi√° tr·ªã uid v√†o thu·ªôc t√≠nh data-userid c·ªßa form
		$('#messageForm').attr('data-userid', uid);		
	</script>
	<script type="module">
		import {initializeApp} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
		import {getStorage, ref, uploadBytes, getDownloadURL} from "https://www.gstatic.com/firebasejs/10.6.0/firebase-storage.js";

		const storage = getStorage();

		// Add event listener for file input change
		const fileInput = document.getElementById("file");
		const imageContainer = document.getElementById("imageContainer");

		fileInput.addEventListener("change", async () => {
			const file = fileInput.files[0];

			// n·∫øu file ƒë∆∞·ª£c ch·ªçn
			if (file) {
				// t·∫£i ·∫£nh l√™n storage c·ªßa firebase
				const storageRef = ref(storage, file.name);
				try {
					const snapshot = await uploadBytes(storageRef, file);

					// l·∫•y ƒë∆∞·ªùng d·∫´n t·ªõi ·∫£nh 
					const downloadURL = await getDownloadURL(storageRef);

					// Hi·ªÉn th·ªã ·∫£nh 
					imageContainer.innerHTML = `<img src="${downloadURL}" alt="Uploaded Image" id="urlImage" style="width: 300px; height: 200px;">`;
						alert('Successfully uploaded to Firebase Storage!');
				} catch (error) {
					console.error('Error uploading to Firebase Storage:', error);
					alert('Error uploading to Firebase Storage. Please try again.');
				}
			} else {
				alert('No file selected.');
			}
		});
	</script>
	<script>
		function sendMessage() {
			var uid = $('#messageForm').data('userid');
			var contentValue = $('#content').val().trim();

			const imageContainer = document.getElementById("imageContainer");
			const imageURL = imageContainer.querySelector("#urlImage") ? imageContainer.querySelector("#urlImage").src : null;

			const contentArea = document.getElementById("content");
			// Ki·ªÉm tra xem content v√† imageURL c√≥ gi√° tr·ªã hay kh√¥ng
			if ((contentValue != '' && contentValue != null) || (imageURL !== "" && imageURL !== null)) {
				// N·∫øu c√≥ n·ªôi dung v√† kh√¥ng c√≥ ·∫£nh
				if (contentValue !== '' && (imageURL == "" || imageURL == null)) {
					contentArea.value = contentValue;
					//alert("N·∫øu c√≥ n·ªôi dung v√† kh√¥ng c√≥ ·∫£nh" + contentArea.value);
				}
				// N·∫øu c√≥ ·∫£nh v√† kh√¥ng c√≥ n·ªôi dung
				else if (contentValue == '' && (imageURL !== "" && imageURL !== null)) {
					contentArea.value = imageURL + "++";
					//alert("N·∫øu c√≥ ·∫£nh v√† kh√¥ng c√≥ n·ªôi dung" + contentArea.value);
				}
				// N·∫øu c·∫£ hai ƒë·ªÅu c√≥
				else {
					contentArea.value = imageURL + "++" + contentValue;
					//alert("N·∫øu c·∫£ hai ƒë·ªÅu c√≥" + contentArea.value);
				}

				// Th√™m gi√° tr·ªã uid v√†o FormData
				var formData = $('#messageForm').serializeArray();
				formData.push({name: 'uid', value: uid});

				$.ajax({
					type: 'POST',
					url: '/send',
					data: formData,
					success: function () {
						$('#content').val(''); // reset √¥ nh·∫≠p tin nh·∫Øn 
						$('#imageContainer').html(''); // reset ·∫£nh  
					},
					error: function () {
						// X·ª≠ l√Ω l·ªói
						alert('Error sending message');
					}
				});
			} else {
				// Th√¥ng b√°o ng∆∞·ªùi d√πng ch∆∞a nh·∫≠p n·ªôi dung ho·∫∑c ch·ªçn ·∫£nh
				alert('Please enter a message or choose an image.');
			}
		}


	</script>
	<script>
		// Th√™m h√†m ƒë·ªÉ x·ª≠ l√Ω s·ª± ki·ªán click v√†o icon
		function addEmojiToContent(emoji) {
			// L·∫•y gi√° tr·ªã hi·ªán t·∫°i c·ªßa n·ªôi dung
			var currentContent = document.getElementById('content').value;
			// Th√™m emoji v√†o n·ªôi dung
			var newContent = currentContent + emoji;
			// G√°n gi√° tr·ªã m·ªõi cho n·ªôi dung
			document.getElementById('content').value = newContent;
		}
	</script>

</head>

<body>
	<div class="tab-pane active fade show " id="link1">
		<div class="row merged">
			<div class="col-lg-12">
				<div class="mesg-area-head">
					<div class="active-user">
						<figure><img src="images/resources/friend-avatar3.jpg" alt="">
							<span class="status f-online"></span>
						</figure>
						<div>
							<h6 class="unread" id="Receiver-Name"></h6>
							<span>Online</span>
						</div>
					</div>
					<ul class="live-calls">
						<li class="audio-call"><span class="fa fa-phone"></span></li>
						<li class="video-call"><span class="fa fa-video"></span></li>
						<li class="uzr-info"><span class="fa fa-info-circle"></span></li>
						<li>
							<div class="dropdown">
								<button class="btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
									<i class="ti-view-grid"></i>
								</button>
								<div class="dropdown-menu dropdown-menu-right">
									<a class="dropdown-item audio-call" href="#"><i class="ti-headphone-alt"></i>Voice
										Call</a>
									<a href="#" class="dropdown-item video-call"><i class="ti-video-camera"></i>Video
										Call</a>
									<hr>
									<a href="#" class="dropdown-item"><i class="ti-server"></i>Clear History</a>
									<a href="#" class="dropdown-item"><i class="ti-hand-stop"></i>Block Contact</a>
									<a href="#" class="dropdown-item"><i class="ti-trash"></i>Delete Contact</a>
								</div>
							</div>
						</li>
					</ul>
				</div>
			</div>
			<div class="col-lg-8 col-md-8">
				<div class="mesge-area with-background">
					<ul id="chat" class="conversations ps-container ps-theme-default ps-active-x ps-active-y">

					</ul>

				</div>


				
				<div class="message-writing-box">
					<div id="imageContainer"></div>
					<form id="messageForm" th:attr="data-userid=${userid}">
						<div class="text-area">
							<input type="text" id="content" name="content" placeholder="write your message here..">
							<button onclick="sendMessage(); return false;"><i class="fa fa-paper-plane-o"></i></button>
						</div>

						<div class="emojies">
							<i><img src="images/smiles/happy-3.png" alt=""></i>
							<ul class="emojies-list">
								<li><a title="" onclick="addEmojiToContent('üò¢')" role="button"><img
											src="images/smiles/unhappy.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòõ')" role="button"><img
											src="images/smiles/tongue-out-1.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòí')" role="button"><img
											src="images/smiles/suspicious.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòä')" role="button"><img
											src="images/smiles/smiling.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòú')" role="button"><img
											src="images/smiles/wink.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòê')" role="button"><img
											src="images/smiles/bored.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò°')" role="button"><img
											src="images/smiles/angry-1.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò†')" role="button"><img
											src="images/smiles/angry.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòï')" role="button"><img
											src="images/smiles/bored-1.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòë')" role="button"><img
											src="images/smiles/bored-2.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòï')" role="button"><img
											src="images/smiles/confused-1.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòñ')" role="button"><img
											src="images/smiles/confused.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò≠')" role="button"><img
											src="images/smiles/crying-1.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò¢')" role="button"><img
											src="images/smiles/crying.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò≥')" role="button"><img
											src="images/smiles/embarrassed.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòÄ')" role="button"><img
											src="images/smiles/emoticons.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòÉ')" role="button"><img
											src="images/smiles/happy-1.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòÑ')" role="button"><img
											src="images/smiles/happy-2.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòä')" role="button"><img
											src="images/smiles/happy-3.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòÜ')" role="button"><img
											src="images/smiles/happy-4.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò∑')" role="button"><img
											src="images/smiles/ill.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòç')" role="button"><img
											src="images/smiles/in-love.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòò')" role="button"><img
											src="images/smiles/kissing.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò†')" role="button"><img
											src="images/smiles/mad.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('ü§ì')" role="button"><img
											src="images/smiles/nerd.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üë∫')" role="button"><img
											src="images/smiles/ninja.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò∂')" role="button"><img
											src="images/smiles/quiet.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòû')" role="button"><img
											src="images/smiles/sad.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('ü§´')" role="button"><img
											src="images/smiles/secret.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòä')" role="button"><img
											src="images/smiles/smile.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòØ')" role="button"><img
											src="images/smiles/surprised-1.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòã')" role="button"><img
											src="images/smiles/tongue-out.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üò¢')" role="button"><img
											src="images/smiles/unhappy.png" alt=""></a></li>
								<li><a title="" onclick="addEmojiToContent('üòí')" role="button"><img
											src="images/smiles/suspicious.png" alt=""></a></li>

							</ul>
						</div>
						<div class="attach-file">
							<label class="fileContainer">
								<i class="ti-clip"></i>
								<input type="file" id="file" name="file">
							</label>
						</div>
					</form>
				</div>
				<div>
					<input type="text" id="userid" name="userid" placeholder="userid" th:value="${session.userInfoID}"
						hidden />
				</div>

			</div>
			<div class="col-lg-4 col-md-4">
				<div class="chater-info">
					<figure><img src="images/resources/chatuser1.jpg" alt=""></figure>
					<h6 id="Receiver-Name-About"></h6>
					<span>Online</span>
					<div class="userabout">
						<span>About</span>
						<p>I love reading, traveling and discovering new things. You need to be happy in life.</p>
						<ul>
							<li>
								<span style="display: inline-block;">Phone: </span>
								<span style="display: inline-block;" th:text="${recipientInfo.phoneNumber}"></span>
							</li>
							<li>
								<span style="display: inline-block;">Address: </span>
								<span style="display: inline-block;" th:text="${recipientInfo.address}"></span>
							</li>


						</ul>
						<div class="media">
							<span>Media</span>
							<ul>
								<li><img src="images/resources/audio-user1.jpg" alt=""></li>
								<li><img src="images/resources/audio-user2.jpg" alt=""></li>
								<li><img src="images/resources/audio-user3.jpg" alt=""></li>
								<li><img src="images/resources/audio-user4.jpg" alt=""></li>
								<li><img src="images/resources/audio-user5.jpg" alt=""></li>
								<li><img src="images/resources/audio-user6.jpg" alt=""></li>
								<li><img src="images/resources/admin2.jpg" alt=""></li>
								<li><img src="images/resources/audio-user1.jpg" alt=""></li>
								<li><img src="images/resources/audio-user4.jpg" alt=""></li>
								<li><img src="images/resources/audio-user3.jpg" alt=""></li>
							</ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script src="js/main.min.js"></script>
	<script src="js/script.js"></script>


</body>

</html>